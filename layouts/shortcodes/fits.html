{{ $fitsData := $.Site.Data.fits.fits }}
{{ $fitsPagePermalink := .Page.Permalink }}
<!-- TODO: implement "jump to" on the side or on the top? -->
<!-- TODO: implement button that allows you to leave a comment or emoji somehow -->
<!-- TODO: add permalink that is accessible via the number. people send the # to me so that's their "UID" -->
<!-- TODO: paginate this so it doesn't bombard people with loading -->
<!-- TODO: add thumbnail URL and also upload to s3 but resized as a thumbnail (400 x 600) and then use thumbnailSrc as the img src -->

<div>
<input id="filterFavorites" class="filterCheckbox" type="checkbox" onchange="filterFits()">
<label class="form-check-label" for="filterFavorites">
    Show all
</label>
</div>
<br/>

<div id="fitsContainer" class="gallery">
    {{ range $index, $element := sort $fitsData "timestamp" "desc" }}
        {{$fitIndex := string (sub (len $fitsData) $index) }}
        {{$fitPermalink := delimit (slice (printf "%s" $fitsPagePermalink) (printf "#%s" $fitIndex)) "" }}
        <!-- NOTE: we replace the extension to jpeg since apple photos preview is always jpeg, not -->
        <!-- whatever the original extension was. -->
        {{$previewImgSrc := replaceRE "\\.([^\\.]+)$" "_preview.jpeg" $element.imgSrc }}
        <div id="{{$fitIndex}}" class="photoCard">
            {{ if $element.favorite }}
            <i class="uis uis-star photoCardFave"></i>
            {{ end }}
            <div class="photoCardMeta">
                <span class="photoCardIdx" onclick="copyLink({{$fitPermalink}})">{{$fitIndex}} <i class="uil uil-link-h" ></i></span>
                <span class="photoCardDate">{{$element.date | dateFormat "01.02.2006"}}</span>
            </div>
            <figure itemscope itemtype="http://schema.org/ImageObject" class="image gallery-item">
                <!-- TODO: calculate proper size based on item and store inside json, needed for animation -->
                <a class="galleryLink" href={{$element.imgSrc}} itemprop="contentUrl" data-size="{{$element.width}}x{{$element.height}}">
                    <!-- Manually setting a 1.5 aspect ratio here using width + height -->
                    <!-- because modern browsers will make sure to reserve space to prevent reflow -->
                    <!-- eventually should calculate it properly and set here and above -->
                    <!-- source: https://www.youtube.com/watch?v=4-d_SoCHeWE -->
                    <!-- and https://www.codecaptain.io/blog/web-development/responsive-images-and-preventing-page-reflow/474 -->
                    <img width="{{$element.width}}" height="{{$element.height}}" class="lazyload photoCardPhoto galleryImage" data-src={{$previewImgSrc}} src={{$previewImgSrc}}  itemprop="thumbnail" alt="galleryImage"/>
                </a>
            </figure>
            <p>{{$element.description}}</p>
        </div>
    {{ end }}
</div>
<div class="scrollUp"><button onclick="scrollUp('filterFavorites')">Back to top</button></div>


<script>
    // handle filtering by favorites
    const getFilterEl = () => document.getElementById("filterFavorites");
    function hide(ele) {
        ele.style.display = "none";
    }

    function show(ele) {
        ele.style.display = "block";
    }

    function filterFits() {
        const showAll = getFilterEl().checked;
        const allFits = Array.from(document.getElementsByClassName("photoCard"));
        const nonFavorites = allFits.filter(ele => !ele.querySelector('.photoCardFave'));
        nonFavorites.forEach(fit => showAll ? show(fit) : hide(fit));
    }
    filterFits();
</script>
